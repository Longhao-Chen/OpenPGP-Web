<!DOCTYPE html>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='black'>
<meta name='format-detection' content='telephone=no'>
<html>
<head>
<meta charset="utf-8">
<title>密钥管理</title>
<link href="css/style.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" type="text/css" />
<script src="https://cdn.staticfile.org/openpgp/4.6.2/openpgp.min.js"></script>
<script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.bundle.js"></script>
<script src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script>
<script src="js/storepub.js"></script>
<script src="js/storepri.js"></script>
<script src="js/config.js"></script>
<script src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js"></script>
<script>
//读取密钥信息的函数
function pubinfo(input,msgbox) {
	try{
		(async () => {
			const key=`${document.getElementById(input).value}`;
			msg="用户标识："+((await openpgp.key.readArmored(key)).keys)[0].getUserIds().toString();
			msg=msg+"\n密钥指纹："+((await openpgp.key.readArmored(key)).keys)[0].getFingerprint().toString();
			msg=msg+"\n创建时间："+((await openpgp.key.readArmored(key)).keys)[0].getCreationTime().toString();
			document.getElementById(msgbox).value=msg;
		})();
		$("#"+msgbox).show("fast");
	}catch(e){
		alert("出错："+e);
	}
}
function priinfo(input,msgbox) {
	try{
		(async () => {
			const key=`${document.getElementById(input).value}`;
			msg="用户标识："+((await openpgp.key.readArmored(key)).keys)[0].getUserIds().toString();
			msg=msg+"\n密钥指纹："+((await openpgp.key.readArmored(key)).keys)[0].getFingerprint().toString();
			msg=msg+"\n创建时间："+((await openpgp.key.readArmored(key)).keys)[0].getCreationTime().toString();
			document.getElementById(msgbox).value=msg;
		})();
		$("#"+msgbox).show("fast");
	}catch(e){
		alert("出错："+e);
	}
}
</script>
<script>
//与界面历史记录和返回有关的函数
function historyadd(href){
	history.pushState(null,null,"keymanage.html#"+href);
}

window.addEventListener("popstate", function(){
	$(".menu").show("slow");
	$(".notmenu").hide("slow");
}, false)
</script>
<script>
//元素的显示和隐藏的处理
function showaddpubkey(){
	$("#addpub").show("slow");
	$(".menu").hide("slow");
	pubsaved();
}
function showaddprikey(){
	$("#addpri").show("slow");
	$(".menu").hide("slow");
	prisaved();
}
function showdelpubkey(){
	$("#delpub").show("slow");
	$(".menu").hide("slow");
	pubdelmenu();
}
function showdelprikey(){
	$("#delpri").show("slow");
	$(".menu").hide("slow");
	pridelmenu();
}
function showgenkey(){
	$("#gen").show("slow");
	$(".menu").hide("slow");
}
function showexppubkey(){
	$("#exppub").show("slow");
	$(".menu").hide("slow");
	exppubmenu();
}
function showexpprikey(){
	$("#exppri").show("slow");
	$(".menu").hide("slow");
	expprimenu();
}
$(function(){
	$("#addpubkey").click(function(){
		historyadd("addpubkey");
		showaddpubkey();
	});
	$("#addprikey").click(function(){
		historyadd("addprikey");
		showaddprikey();
	});
	$("#delpubkey").click(function(){
		historyadd("delpubkey");
		showdelpubkey();
	});
	$("#delprikey").click(function(){
		historyadd("delprikey");
		showdelprikey()
	});
	$("#genkey").click(function(){
		historyadd("genkey");
		showgenkey();
	});
	$("#exppubkey").click(function(){
		historyadd("exppubkey");
		showexppubkey();
	});
	$("#expprikey").click(function(){
		historyadd("expprikey");
		showexpprikey();
	});
	$("#gen_gen").click(function(){
		$("#gen_alert").show("slow");
	});
	$("#gen_show_passwd").click(function(){
		if(document.getElementById("gen_show_passwd").checked){
			$("#gen_passwd").attr("type","text");
		}else{
			$("#gen_passwd").attr("type","password");
		}
	});
	$("#gen_show_adv").click(function(){
		if(document.getElementById("gen_show_adv").checked){
			$("#gen_adv").show("fast");
		}else{
			$("#gen_adv").hide("fast");
		}
	});
	$(".alertclose").click(function(){
		$(".alert").hide("slow");
	})
});
$(function(){
	$(".notmenu").hide();
	$(".alert").hide();
	$("#pubmsg").hide();
	$("#primsg").hide();
	$(".gen_keys").hide();
	$(".exp_prikey").hide();
	$(".exp_pubkey").hide();
	$("#gen_adv").hide();

	//保证重新刷新后仍然在原界面
	if(window.location.hash==='#addpubkey')
		showaddpubkey();
	if(window.location.hash==='#addprikey')
		showaddprikey();
	if(window.location.hash==='#delpubkey')
		showdelpubkey();
	if(window.location.hash==='#delprikey')
		showdelprikey();
	if(window.location.hash==='#genkey')
		showgenkey();
	if(window.location.hash==='#exppubkey')
		showexppubkey();
	if(window.location.hash==='#expprikey')
		showexpprikey();
	if(document.getElementById("gen_show_passwd").checked){
		$("#gen_passwd").attr("type","text");
	}else{
		$("#gen_passwd").attr("type","password");
	}
	if(document.getElementById("gen_show_adv").checked){
		$("#gen_adv").show("fast");
	}else{
		$("#gen_adv").hide("fast");
	}
})
</script>
<script>
//核心的一些处理函数
function addpub(){
	pub=document.getElementById("pubkey").value;
	name=document.getElementById("pubalias").value;
	if(name===''){
		alert("公钥别名不能为空！");
	}else if(pub===''){
		alert("公钥输入不能为空！");
	} else {
		PubSave(name,pub);
		$("#pubaddalert").show("slow");
	}
}
function addpri(){
	pri=document.getElementById("prikey").value;
	name=document.getElementById("prialias").value;
	if(name===''){
		alert("私钥别名不能为空！");
	} else if(pri===''){
		alert("私钥输入不能为空！");
	} else {
		if(document.getElementById("onlocal").checked){
			PriLocalSave(name,pri);
		}else{
			PriSessSave(name,pri);
		}
		$("#priaddalert").show("slow");
	}
}
function pubdelmenu(){
	res=PubReadIndex();
	len=res.length;
	var msg='';
	if(len===0){
		msg='<a class="dropdown-item" >无已保存的公钥</a>'
	}else{
		for(var i=0;i<len;++i){
			msg=msg+'<a class="dropdown-item pubdelreload" onclick="PubDel('+res[i][0]+');pubdelmenu();">'+res[i][1]+'</a>'
		}
	}
	document.getElementById("delpubmenu").innerHTML=msg;
}
function pridelmenu(){
	res=PriReadIndex();
	len=res.length;
	var msg='';
	if(len===0){
		msg='<a class="dropdown-item" >无已保存的私钥</a>'
	}else{
		for(var i=0;i<len;++i){
			msg=msg+'<a class="dropdown-item" onclick="PriDel('+res[i][0]+');pridelmenu();">'+res[i][1]+'</a>'
		}
	}
	document.getElementById("delprimenu").innerHTML=msg;
}
function genkey(){
	if(document.getElementById("gen_name").value===''){
		alert("姓名不能为空！");
	}else{
		try{
			(async () => {
				const { privateKeyArmored, publicKeyArmored, revocationCertificate } = await openpgp.generateKey({
					userIds: [{ name: document.getElementById("gen_name").value, email: document.getElementById("gen_mail").value }], // you can pass multiple user IDs
					rsaBits: document.getElementById("keybit").innerHTML,                                              // RSA key size
					passphrase: document.getElementById("gen_passwd").value           // protects the private key
				});
				document.getElementById("gen_pub").value=publicKeyArmored;
				document.getElementById("gen_pri").value=privateKeyArmored;
				$(".gen_keys").show("slow");
				$("#gen_alert").hide("slow");
			})();
		}catch(e){
			$("#gen_alert").hide("slow");
			alert("出错："+e);
		}
	}
}

function setbit(bit){
	document.getElementById("keybit").innerHTML=bit;
}

//保存生成的密钥
function gen_save(){
	name=document.getElementById("gen_name").value;
	if(name===''){
		alert("姓名不能为空！");
	}else{
		pub=document.getElementById("gen_pub").value;
		pri=document.getElementById("gen_pri").value;
		PubSave(name,pub);
		PriLocalSave(name,pri);
		$("#gen_savealert").show("slow");
	}
}
function pubsaved(){
	res=PubReadIndex();
	len=res.length;
	var msg='';
	if(len===0){
		msg='无已保存的公钥'
	}else{
		for(var i=0;i<len;++i){
			msg=msg+res[i][1]+"\n"
		}
	}
	document.getElementById("pubsaved").value=msg;
}
function prisaved(){
	res=PriReadIndex();
	len=res.length;
	var msg='';
	if(len===0){
		msg='无已保存的私钥'
	}else{
		for(var i=0;i<len;++i){
			msg=msg+res[i][1]+"\n"
		}
	}
	document.getElementById("prisaved").value=msg;
}
function exppubmenu(){
	res=PubReadIndex();
	len=res.length;
	var msg='';
	if(len===0){
		msg='<a class="dropdown-item" >无已保存的公钥</a>'
	}else{
		for(var i=0;i<len;++i){
			msg=msg+'<a class="dropdown-item pubdelreload" onclick="exppub('+res[i][0]+');exppubmenu();">'+res[i][1]+'</a>'
		}
	}
	document.getElementById("exppubmenu").innerHTML=msg;
}
function expprimenu(){
	res=PriReadIndex();
	len=res.length;
	var msg='';
	if(len===0){
		msg='<a class="dropdown-item" >无已保存的私钥</a>'
	}else{
		for(var i=0;i<len;++i){
			msg=msg+'<a class="dropdown-item pubdelreload" onclick="exppri('+res[i][0]+');expprimenu();">'+res[i][1]+'</a>'
		}
	}
	document.getElementById("expprimenu").innerHTML=msg;
}
function exppub(id){
	document.getElementById("exp_pubkey").value=PubRead(id);
	$(".exp_pubkey").show("slow");
}
function exppri(id){
	document.getElementById("exp_prikey").value=PriRead(id);
	$(".exp_prikey").show("slow");
}
</script>
<script>
//文本框的清理和隐藏
function cleanall(){
	document.getElementById("pubkey").value='';
	$("#pubmsg").hide();
	document.getElementById("prikey").value='';
	$("#primsg").hide();
}
</script>
<script>
//复制部分的代码
$(function(){
	var clipboard = new ClipboardJS('.copy');
	clipboard.on('success', function(e) {
		alert('复制成功');
		e.clearSelection();
	});
	clipboard.on('error', function(e) {
		alert('复制失败，您的浏览器不支持！');
	});
});
</script>
</head>
<body class="container-fluid center">
	<h1>密钥管理</h1>
	<div class="row menu mx-auto" style="width: 100%;">
		<button type="button" class="col-sm-4 offset-sm-1 col-10 offset-1 btn btn-light btn-lg menu" id="genkey">生成一个密钥对</button>
		<button type="button" class="col-sm-4 offset-sm-2 col-10 offset-1 btn btn-light btn-lg menu" id="addpubkey">添加公钥</button>
		<button type="button" class="col-sm-4 offset-sm-1 col-10 offset-1 btn btn-light btn-lg menu" id="exppubkey">导出公钥</button>
		<button type="button" class="col-sm-4 offset-sm-2 col-10 offset-1 btn btn-light btn-lg menu" id="delpubkey">删除公钥</button>
		<button type="button" class="col-sm-4 offset-sm-1 col-10 offset-1 btn btn-danger btn-lg menu" onclick="PubDelAll()">删除所有公钥</button>
		<button type="button" class="col-sm-4 offset-sm-2 col-10 offset-1 btn btn-light btn-lg menu" id="addprikey">添加私钥</button>
		<button type="button" class="col-sm-4 offset-sm-1 col-10 offset-1 btn btn-warning btn-lg menu" id="expprikey">导出私钥</button>
		<button type="button" class="col-sm-4 offset-sm-2 col-10 offset-1 btn btn-light btn-lg menu" id="delprikey">删除私钥</button>
		<button type="button" class="col-sm-4 offset-sm-1 col-10 offset-1 btn btn-danger btn-lg menu" onclick="PriDelAll()">删除所有私钥</button>
	</div>

	<div class="notmenu" id="gen">
		<form>
			<input class="input-inherit" id="gen_name" placeholder="姓名"><br>
			<input class="input-inherit" id="gen_mail" placeholder="电子邮件（可选）"><br>
			<input class="input-inherit" id="gen_passwd" type="password" placeholder="私钥密码（此密码是保护私钥的最后手段）"><br>
			<div class="from-check">
				<label class="from-check-label">
					<input type="checkbox" id="gen_show_passwd">显示密码<br>
				</label>
				<label class="from-check-label">
					<input type="checkbox" id="gen_show_adv">显示高级设置<br>
				</label>
			</div>
		</form>
		<div id="gen_adv">
			<p>密钥尺寸（位）：</p>
			<div class="dropdown">
				<button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" id="keybit">
					2048
				</button>
				<div class="dropdown-menu" id="delprimenu">
					<a class="dropdown-item" onclick="setbit(2048)">2048</a>
					<a class="dropdown-item" onclick="setbit(3072)">3072</a>
					<a class="dropdown-item" onclick="setbit(4096)">4096</a>
				</div>
			</div>
			<p>关于密钥尺寸请参考说明文档。</p>
		</div>
		<button type="button" class="btn btn-primary" onclick="genkey();"id="gen_gen">确认生成此密钥</button>
		<div class="alert alert-success alert-dismissible" id="gen_alert">
			<p>注意：生成密钥需要较长的时间以得到足够的熵，请耐心等待。</p>
		</div>
		<p class="gen_keys">生成的公钥:</p>
		<textarea readonly rows="10" class="textarea-inherit gen_keys" id="gen_pub"></textarea><br class="gen_keys">
		<p class="gen_keys">生成的私钥:</p>
		<textarea readonly rows="10" class="textarea-inherit gen_keys" id="gen_pri"></textarea><br class="gen_keys">
		<div class="row">
			<button type="button" class="btn btn-primary col gen_keys copy" data-clipboard-target="#gen_pub">复制生成的公钥</button>
			<button type="button" class="btn btn-primary col gen_keys copy" data-clipboard-target="#gen_pri">复制生成的私钥</button>
		</div>
		<div class="alert alert-success alert-dismissible" id="gen_savealert">
			<button type="button" class="alertclose btn" data-dismiss="alert">&times;</button>
			<strong>成功!</strong> 密钥对保存成功。
		</div>
		<button type="button" class="btn btn-primary gen_keys" onclick="gen_save()">将密钥对保存到浏览器（使用localStorage）</button>
	</div>

	<div class="notmenu" id="addpub">
		<p>目前已保存的公钥：</p>
		<textarea id="pubsaved" rows="5" class="textarea-inherit" readonly></textarea><br>
		<textarea id='pubkey' rows="10" class="textarea-inherit" placeholder="请在此粘贴公钥"></textarea><br>
		<button type="button" class="btn btn-primary" onclick="pubinfo('pubkey','pubmsg')">查看公钥信息</button>
		<button type="button" class="btn btn-danger" onclick="cleanall()">清空文本框</button><br>
		<textarea id="pubmsg" rows="4" class="textarea-inherit" readonly></textarea><br>
		<form>
			<input class="input-inherit" id="pubalias" placeholder="公钥别名"><br>
		</form>
		<div class="alert alert-success alert-dismissible" id="pubaddalert">
			<button type="button" class="alertclose btn" data-dismiss="alert">&times;</button>
			<strong>成功!</strong> 此公钥添加成功。
		</div>
		<button type="button" class="btn btn-primary" onclick="addpub()">确认添加此公钥</button>
	</div>

	<div class="notmenu" id="exppub">
		<div class="dropdown">
			<button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
				请选择要导出的公钥
			</button>
			<div class="dropdown-menu" id="exppubmenu">
			</div>
		</div>
		<textarea id="exp_pubkey" rows="10" class="textarea-inherit exp_pubkey" readonly></textarea><br class="exp_pubkey">
		<button class="exp_pubkey copy btn btn-primary" data-clipboard-target="#exp_pubkey">复制密钥</button>
	</div>

	<div class="notmenu" id="exppri">
		<div class="dropdown">
			<button type="button" class="btn btn-warning dropdown-toggle" data-toggle="dropdown">
				请选择要导出的私钥
			</button>
			<div class="dropdown-menu" id="expprimenu">
			</div>
		</div>
		<textarea id="exp_prikey" rows="10" class="textarea-inherit exp_prikey" readonly></textarea><br class="exp_prikey">
		<button class="exp_prikey copy btn btn-warning" data-clipboard-target="#exp_prikey">复制密钥</button>
	</div>

	<div class="notmenu" id="addpri">
		<p>目前已保存的私钥</p>
		<textarea id="prisaved" rows="5" class="textarea-inherit" readonly></textarea><br>
		<textarea id='prikey' rows="10" class="textarea-inherit" placeholder="请在此粘贴私钥"></textarea><br>
		<button onclick="priinfo('prikey','primsg')" class="btn btn-primary" >查看私钥信息</button>
		<button type="button" class="btn btn-danger" onclick="cleanall()">清空文本框</button><br>
		<textarea id="primsg" rows="4" class="textarea-inherit" readonly ></textarea><br>
		<form>
			<input class="input-inherit" id="prialias" placeholder="私钥别名"><br>
			<div class="from-check">
				<label class="from-check-label">
					<input type="checkbox" id="onlocal">持久储存（如果选中此项则使用localStorage储存，否则使用sessionStorage储存<br>
				</label>
			</div>
			</form>
		<div class="alert alert-success alert-dismissible" id="priaddalert">
			<button type="button" class="alertclose btn" data-dismiss="alert">&times;</button>
			<strong>成功!</strong> 此私钥添加成功。
		</div>
		<button type="button" class="btn btn-primary" onclick="addpri()">确认添加此私钥</button>
	</div>

	<div class="notmenu" id="delpub">
		<div class="dropdown">
			<button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
				请选择要删除的公钥
			</button>
			<div class="dropdown-menu" id="delpubmenu">
			</div>
		</div>
	</div>

	<div class="notmenu" id="delpri">
		<div class="dropdown">
			<button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
				请选择要删除的私钥
			</button>
			<div class="dropdown-menu" id="delprimenu">
			</div>
		</div>
	</div>
</body>
</html>