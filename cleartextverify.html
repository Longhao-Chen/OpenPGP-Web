<!DOCTYPE html>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='black'>
<meta name='format-detection' content='telephone=no'>
<html>
<head>
<meta charset="utf-8">
<title>验证明文签名</title>
<link href="css/style.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" type="text/css" />
<script src="https://cdn.staticfile.org/openpgp/4.6.2/openpgp.min.js"></script>
<script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.bundle.js"></script>
<script src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script>
<script src="js/storepub.js"></script>
<script src="js/storepri.js"></script>
<script src="js/config.js"></script>
<script src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js"></script>
</head>
<body class="container-fluid center">
<script>
function verify(){
	(async () => {
		if(document.getElementById("pubdata").value===''){
			window.alert("请选择密钥！");
			return -1;
		}
		const publicKeyArmored = `${PriRead(document.getElementById("pubdata").value)}`;

		try{
			const verified = await openpgp.verify({
				message: await openpgp.cleartext.readArmored(document.getElementById("text").value),           // parse armored message
				publicKeys: (await openpgp.key.readArmored(publicKeyArmored)).keys // for verification
			});
			const { valid } = verified.signatures[0];
			if (valid) {
				$("#signmsg").show("slow");
			} else {
				$("#signmsg").hide();
				alert("签名验证失败\n公钥选择错误或信息被篡改");
			}
		}catch(e){
			window.alert("出现错误\n错误代码:"+e);
			return -1;
		}
		await openpgp.destroyWorker();
	})();
}
</script>
<script>
//元素显示和隐藏
$(function(){
	$(".pubmsg").hide();
	$("#pubdata").hide();
	$("#signmsg").hide();
})
</script>
<script>
//清空和隐藏文本框
function cleanall(){
	document.getElementById("text").value='';
	$("#signmsg").hide();
}
</script>
<script>
//密钥选择部分
$(function(){
	res=PubReadIndex();
	len=res.length;
	msg='';
	if(len===0){
		msg='<a class="dropdown-item" >无已保存的公钥，请添加公钥</a>'
	}else{
		for(var i=0;i<len;++i){
			msg=msg+'<a class="dropdown-item" onclick="Pub('+res[i][0]+',\''+res[i][1]+'\');">'+res[i][1]+'</a>'
		}
	}
	document.getElementById("pubmenu").innerHTML=msg;
});

function Pub(id,name){
	document.getElementById("pubmsg").value=name;
	document.getElementById("pubdata").value=id;
	$(".pubmsg").show("fast");
}
</script>
<h1>验证明文签名</h1>
<div class="dropdown">
	<button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
		请选择公钥
	</button>
	<div class="dropdown-menu" id="pubmenu">
	</div>
	<p class="pubmsg">已选择的公钥：</p>
	<textarea id="pubmsg" class="pubmsg textarea-inherit" readonly rows="1" ></textarea><br class="pubmsg">
</div>
<!-- 下面仅用于保存数据 -->
<textarea id="pubdata"></textarea>
<textarea id="text" rows="20" class="textarea-inherit" placeholder="请粘贴签名信息"></textarea><br>
<div class="row">
	<button type="button" onclick="verify()" class="col btn btn-primary">验证</button>
	<button type="button" class="btn btn-danger" onclick="cleanall()">清空文本框</button><br>
</div>
<div class="alert alert-success alert-dismissible" id="signmsg">
	签名有效
</div>
</body>
</html>