<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>添加密钥</title>
<link rel="stylesheet" href="css/bootstrap.min.css">
<script src="js/openpgp.min.js"></script>
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.bundle.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/storepub.js"></script>
<script src="js/storepri.js"></script>
<script src="js/clipboard.min.js"></script>
<script>
//读取密钥信息的函数
function pubinfo(input,msgbox) {
	(async () => {
		const key=`${document.getElementById(input).value}`;
		msg="用户标识："+((await openpgp.key.readArmored(key)).keys)[0].getUserIds().toString();
		msg=msg+"\n密钥指纹："+((await openpgp.key.readArmored(key)).keys)[0].getFingerprint().toString();
		msg=msg+"\n创建时间："+((await openpgp.key.readArmored(key)).keys)[0].getCreationTime().toString();
		document.getElementById(msgbox).value=msg;
	})();
	$("#"+msgbox).show("fast");
}
</script>
<script>
//与界面历史记录和返回有关的函数
	function historyadd(href){
		history.pushState(null,null,"addkey.html#"+href);
	}

	window.addEventListener("popstate", function(){
		$(".menu").show("slow");
		$(".notmenu").hide("slow");
	}, false)
</script>
<script>
//元素的显示和隐藏的处理
	function showaddpubkey(){
		$("#addpub").show("slow");
		$(".menu").hide("slow");
		pubsaved();
	}
	function showaddprikey(){
		$("#addpri").show("slow");
		$(".menu").hide("slow");
		prisaved();
	}
	function showdelpubkey(){
		$("#delpub").show("slow");
		$(".menu").hide("slow");
		pubdelmenu();
	}
	function showdelprikey(){
		$("#delpri").show("slow");
		$(".menu").hide("slow");
		pridelmenu();
	}
	function showgenkey(){
		$("#gen").show("slow");
		$(".menu").hide("slow");
	}
	$(function(){
		$("#addpubkey").click(function(){
			historyadd("addpubkey");
			showaddpubkey();
		});
		$("#addprikey").click(function(){
			historyadd("addprikey");
			showaddprikey();
		});
		$("#delpubkey").click(function(){
			historyadd("delpubkey");
			showdelpubkey();
		});
		$("#delprikey").click(function(){
			historyadd("delprikey");
			showdelprikey()
		});
		$("#genkey").click(function(){
			historyadd("genkey");
			showgenkey();
		});
		$("#gen_gen").click(function(){
			$(".gen_keys").show("slow");
		});
		$("#gen_show_passwd").click(function(){
			if(document.getElementById("gen_show_passwd").checked){
				$("#gen_passwd").attr("type","text");
			}else{
				$("#gen_passwd").attr("type","password");
			}
		});
	});
	$(function(){
		$(".notmenu").hide();
		$("#pubmsg").hide();
		$(".gen_keys").hide();
		if(window.location.hash==='#addpubkey')
			showaddpubkey();
		if(window.location.hash==='#addprikey')
			showaddprikey();
		if(window.location.hash==='#delpubkey')
			showdelpubkey();
		if(window.location.hash==='#delprikey')
			showdelprikey();
		if(window.location.hash==='#genkey')
			showgenkey();
		
		if(document.getElementById("gen_show_passwd").checked){
			$("#gen_passwd").attr("type","text");
		}else{
			$("#gen_passwd").attr("type","password");
		}
	})
</script>
<script>
//核心的一些处理函数
	function addpub(){
		pub=document.getElementById("pubkey").value;
		name=document.getElementById("pubalias").value;
		PubSave(name,pub);
	}
	function addpri(){
		pri=document.getElementById("prikey").value;
		name=document.getElementById("prialias").value;
		if(document.getElementById("onlocal").checked){
			PriLocalSave(name,pri);
		}else{
			PriSessSave(name,pri);
		}
	}
	function pubdelmenu(){
		res=PubReadIndex();
		len=res.length;
		var msg='';
		if(len===0){
			msg='<a class="dropdown-item" >无已保存的公钥</a>'
		}else{
			for(var i=0;i<len;++i){
				msg=msg+'<a class="dropdown-item pubdelreload" onclick="PubDel('+res[i][0]+');pubdelmenu();">'+res[i][1]+'</a>'
			}
		}
		document.getElementById("delpubmenu").innerHTML=msg;
	}
	function pridelmenu(){
		res=PriReadIndex();
		len=res.length;
		var msg='';
		if(len===0){
			msg='<a class="dropdown-item" >无已保存的私钥</a>'
		}else{
			for(var i=0;i<len;++i){
				msg=msg+'<a class="dropdown-item" onclick="PriDel('+res[i][0]+');pridelmenu();">'+res[i][1]+'</a>'
			}
		}
		document.getElementById("delprimenu").innerHTML=msg;
	}
	function genkey(){
		(async () => {
			const { privateKeyArmored, publicKeyArmored, revocationCertificate } = await openpgp.generateKey({
				userIds: [{ name: document.getElementById("gen_name").value, email: document.getElementById("gen_mail").value }], // you can pass multiple user IDs
				rsaBits: 4096,                                              // RSA key size
				passphrase: document.getElementById("gen_passwd").value           // protects the private key
			});
			document.getElementById("gen_pub").value=publicKeyArmored;
			document.getElementById("gen_pri").value=privateKeyArmored;
			document.getElementById("gen_rev").value=revocationCertificate;
		})();
	}
	function gen_save(){
		name=document.getElementById("gen_name").value;
		pub=document.getElementById("gen_pub").value;
		pri=document.getElementById("gen_pri").value;
		PubSave(name,pub);
		PriLocalSave(name,pri);
	}
	function pubsaved(){
		res=PubReadIndex();
		len=res.length;
		var msg='';
		if(len===0){
			msg='无已保存的公钥'
		}else{
			for(var i=0;i<len;++i){
				msg=msg+res[i][1]+"\n"
			}
		}
		document.getElementById("pubsaved").value=msg;
	}
	function prisaved(){
		res=PriReadIndex();
		len=res.length;
		var msg='';
		if(len===0){
			msg='无已保存的私钥'
		}else{
			for(var i=0;i<len;++i){
				msg=msg+res[i][1]+"\n"
			}
		}
		document.getElementById("prisaved").value=msg;
	}
</script>
<script>
//复制部分的代码
	$(function(){
		var clipboard = new ClipboardJS('.copy');
		clipboard.on('success', function(e) {
			e.clearSelection();
		});
		clipboard.on('error', function(e) {
			alert('复制失败，您的浏览器不支持！')
		});
	});
</script>
</head>
<body class="container-fluid">
	<div class="col menu btn-group-vertical">
		<button type="button" class="row btn btn-primary btn-lg menu" id="genkey">生成一个密钥对</button><hr>
		<button type="button" class="row btn btn-primary btn-lg menu" id="addpubkey">添加公钥</button><hr>
		<button type="button" class="row btn btn-primary btn-lg menu" id="delpubkey">删除公钥</button><hr>
		<button type="button" class="row btn btn-danger btn-lg menu" onclick="PubDelAll()">删除所有公钥</button><hr>
		<button type="button" class="row btn btn-primary btn-lg menu" id="addprikey">添加私钥</button><hr>
		<button type="button" class="row btn btn-primary btn-lg menu" id="delprikey">删除私钥</button><hr>
		<button type="button" class="row btn btn-danger btn-lg menu" onclick="PriDelAll()">删除所有私钥</button><hr>
	</div>

	<div class="notmenu" id="gen">
		<form>
			<input id="gen_name" placeholder="姓名"><br>
			<input id="gen_mail" placeholder="电子邮件（可选）"><br>
			<input id="gen_passwd" type="password" placeholder="私钥密码（此密码是保护私钥的最后手段）"><br>
			<input type="checkbox" id="gen_show_passwd">显示密码<br>
		</form>
		<button type="button" class="btn btn-primary" onclick="genkey();"id="gen_gen">确认生成此密钥</button>
		<p>注意：生成密钥需要较长的时间以得到足够的熵，请耐心等待。</p>
		<p class="gen_keys">生成的公钥:</p>
		<textarea readonly rows="10" cols="30" class="gen_keys" id="gen_pub"></textarea><br class="gen_keys">
		<p class="gen_keys">生成的私钥:</p>
		<textarea readonly rows="10" cols="30" class="gen_keys" id="gen_pri"></textarea><br class="gen_keys">
		<p class="gen_keys">生成的吊销密钥:</p>
		<textarea readonly rows="10" cols="30" class="gen_keys" id="gen_rev"></textarea><br class="gen_keys">
		<button type="button" class="btn btn-primary gen_keys copy" data-clipboard-target="#gen_pub">复制生成的公钥</button>
		<button type="button" class="btn btn-primary gen_keys copy" data-clipboard-target="#gen_pri">复制生成的私钥</button>
		<button type="button" class="btn btn-primary gen_keys copy" data-clipboard-target="#gen_rev">复制生成的吊销密钥</button>
		<button type="button" class="btn btn-primary gen_keys" onclick="gen_save()">将密钥对保存到浏览器（使用localStorage）</button>
	</div>

	<div class="notmenu" id="addpub">
		<p>目前已保存的公钥：</p>
		<textarea id="pubsaved" rows="5" cols="30" readonly></textarea><br>
		<textarea id='pubkey' rows="10" cols="30" placeholder="请在此粘贴公钥"></textarea><br>
		<button type="button" class="btn btn-primary" onclick="pubinfo('pubkey','pubmsg')">查看公钥信息</button><br>
		<textarea id="pubmsg" rows="4" cols="30" readonly></textarea><br>
		<form>
			<input id="pubalias" placeholder="公钥别名"><br>
		</form>
		<button type="button" class="btn btn-primary" onclick="addpub()">确认添加此公钥</button>
	</div>

	<div class="notmenu" id="addpri">
		<p>目前已保存的私钥</p>
		<textarea id="prisaved" rows="5" cols="30" readonly></textarea><br>
		<textarea id='prikey' rows="10" cols="30" placeholder="请在此粘贴私钥"></textarea><br>
		<form>
			<input id="prialias" placeholder="私钥别名"><br>
			<input type="checkbox" id="onlocal">持久储存（如果选中此项则使用localStorage储存，否则使用sessionStorage储存<br>
		</form>
		<button type="button" class="btn btn-primary" onclick="addpri()">确认添加此私钥</button>
	</div>

	<div class="notmenu" id="delpub">
		<button type="button" class="btn btn-primary returnmenu">返回主界面</button><br>
		<div class="dropdown">
			<button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
				请选择要删除的公钥。
			</button>
			<div class="dropdown-menu" id="delpubmenu">
			</div>
		</div>      
	</div>

	<div class="notmenu" id="delpri">
		<div class="dropdown">
			<button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
				请选择要删除的私钥。
			</button>
			<div class="dropdown-menu" id="delprimenu">
			</div>
		</div>      
	</div>
</body>
</html>